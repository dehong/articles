# Table of Contents

  * [多线程介绍](#多线程介绍)
    * [基本概念](#基本概念)
    * [Java中的多线程](#java中的多线程)
    * [多线程的优点](#多线程的优点)
    * [多线程的代价](#多线程的代价)


## 多线程介绍
### 基本概念
现在的操作系统是多任务操作系统。多线程是实现多任务的一种方式。

**进程**是指一个内存中运行的应用程序，每个进程都有自己独立的一块内存空间，一个进程中可以启动多个线程。比如在Windows系统中，一个运行的exe就是一个进程。

**线程**是指进程中的一个执行流程，一个进程中可以运行多个线程。比如java.exe进程中可以运行很多线程。线程总是属于某个进程，进程中的多个线程共享进程的内存。

“同时”执行是人的感觉，在线程之间实际上轮换执行。

多线程可以是提高某些类型程序性能的好方法。然而，多线程比多任务更具挑战性。因为线程在相同的程序中执行，因此读取和写入都在同一个存储器。这可能导致出现在单线程程序中看不到错误。在单CPU机器上可能看不到这些错误，因为两个线程从未真正执行“同时”。现代电脑虽然配有多核CPU，甚至还有多个CPU。这意味着单独的线程可以由单独的内核或CPU同时执行。

如果一个线程在另一个线程写入时读取内存位置，那么第一个线程将会读取什么值？旧值？第二个线程写的值？还是两者之间的混合？或者，如果两个线程同时写入同一个内存位置，完成后会留下什么值？第一个线程写的值？第二个线程写的值？还是混合两个值？  没有适当的预防措施，任何这些结果都是可能的,甚至不可预测。结果可能会不时变化。因此，开发人员知道如何采取正确的预防措施是非常重要的 - 意味着学习控制线程如何访问内存，文件，数据库等共享资源。

### Java中的多线程
在Java中，“线程”指两件不同的事情： 
1、java.lang.Thread类的一个实例；
2、线程的执行。

使用java.lang.Thread类或者java.lang.Runnable接口编写代码来定义、实例化和启动新线程。

一个Thread类实例只是一个对象，像Java中的任何其他对象一样，具有变量和方法，生死于堆上。

Java中，每个线程都有一个调用栈，即使不在程序中创建任何新的线程，线程也在后台运行着。

一个Java应用总是从main()方法开始运行，mian()方法运行在一个线程内，它被称为主线程。

一旦创建一个新的线程，就产生一个新的调用栈。

线程总体分两类：用户线程和守候线程。

当所有用户线程执行完毕的时候，JVM自动关闭。但是守候线程却不独立于JVM，守候线程一般是由操作系统或者用户自己创建的。

### 多线程的优点
尽管面临很多挑战，多线程有一些优点使得它一直被使用。这些优点是：
* 资源利用率更好
* 程序设计在某些情况下更简单
* 程序响应更快

### 多线程的代价
从一个单线程的应用到一个多线程的应用并不仅仅带来好处，它也会有一些代价。不要仅仅为了使用多线程而使用多线程。而应该明确在使用多线程时能多来的好处比所付出的代价大的时候，才使用多线程。如果存在疑问，应该尝试测量一下应用程序的性能和响应能力，而不只是猜测。
* 设计更复杂
虽然有一些多线程应用程序比单线程的应用程序要简单，但其他的一般都更复杂。在多线程访问共享数据的时候，这部分代码需要特别的注意。线程之间的交互往往非常复杂。不正确的线程同步产生的错误非常难以被发现，并且重现以修复。

* 上下文切换的开销
当CPU从执行一个线程切换到执行另外一个线程的时候，它需要先存储当前线程的本地的数据，程序指针等，然后载入另一个线程的本地数据，程序指针等，最后才开始执行。这种切换称为“上下文切换”(“context switch”)。CPU会在一个上下文中执行一个线程，然后切换到另外一个上下文中执行另外一个线程。

上下文切换并不廉价。如果没有必要，应该减少上下文切换的发生。

你可以通过维基百科阅读更多的关于上下文切换相关的内容：

* 增加资源消耗
线程在运行的时候需要从计算机里面得到一些资源。除了CPU，线程还需要一些内存来维持它本地的堆栈。它也需要占用操作系统中一些资源来管理线程。我们可以尝试编写一个程序，让它创建100个线程，这些线程什么事情都不做，只是在等待，然后看看这个程序在运行的时候占用了多少内存。
